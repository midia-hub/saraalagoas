name: Cron – Publicações Sociais Agendadas

# Horário em UTC (BRT = UTC-3)
# 09:00 BRT = 12:00 UTC
#
# Segredos necessários no repositório (Settings → Secrets → Actions):
#   APP_URL     → URL de produção, ex: https://sua-app.vercel.app
#   CRON_SECRET → mesmo valor de CRON_SECRET nas env vars da Vercel

on:
  schedule:
    # 12:00 UTC = 09:00 BRT diariamente
    - cron: '0 12 * * *'

  workflow_dispatch: {}

jobs:
  run-scheduled:
    name: Disparar publicações agendadas
    runs-on: ubuntu-latest
    steps:
      - name: Chamar endpoint de publicações
        run: |
          HTTP_STATUS=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
            -X GET \
            "${{ secrets.APP_URL }}/api/social/run-scheduled" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}")
          cat /tmp/response.txt
          echo ""
          echo "HTTP Status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "::error::Endpoint retornou status $HTTP_STATUS"
            exit 1
          fi
