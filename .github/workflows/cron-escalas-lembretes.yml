name: Cron – Lembretes de Escala

# Horários em UTC (BRT = UTC-3)
# Todos os lembretes configurados para 12:50 BRT (15:50 UTC)
#
# ⚠ GitHub Actions pode atrasar até ~15 min no plano gratuito.
#
# Segredos necessários no repositório (Settings → Secrets → Actions):
#   APP_URL     → URL de produção, ex: https://sua-app.vercel.app
#   CRON_SECRET → mesmo valor de CRON_SECRET nas env vars da Vercel

on:
  schedule:
    # 15:50 UTC = 12:50 BRT diariamente
    - cron: '50 15 * * *'

  # Permite disparar manualmente pela aba Actions no GitHub
  workflow_dispatch:
    inputs:
      tipo:
        description: 'Tipo de lembrete'
        required: true
        default: 'dia_da_escala'
        type: choice
        options:
          - lembrete_3dias
          - lembrete_1dia
          - dia_da_escala

jobs:
  lembrete_3dias:
    name: Lembrete 3 dias antes
    if: github.event.schedule == '50 15 * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.tipo == 'lembrete_3dias')
    runs-on: ubuntu-latest
    steps:
      - name: Chamar endpoint de lembrete
        run: |
          HTTP_STATUS=$(curl -sL -o /tmp/response.txt -w "%{http_code}" \
            -X GET \
            "${{ secrets.APP_URL }}/api/cron/escalas-lembretes?tipo=lembrete_3dias" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}")
          cat /tmp/response.txt
          echo ""
          echo "HTTP Status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "::error::Endpoint retornou status $HTTP_STATUS"
            exit 1
          fi

  lembrete_1dia:
    name: Lembrete 1 dia antes
    if: github.event.schedule == '50 15 * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.tipo == 'lembrete_1dia')
    runs-on: ubuntu-latest
    steps:
      - name: Chamar endpoint de lembrete
        run: |
          HTTP_STATUS=$(curl -sL -o /tmp/response.txt -w "%{http_code}" \
            -X GET \
            "${{ secrets.APP_URL }}/api/cron/escalas-lembretes?tipo=lembrete_1dia" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}")
          cat /tmp/response.txt
          echo ""
          echo "HTTP Status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "::error::Endpoint retornou status $HTTP_STATUS"
            exit 1
          fi

  dia_da_escala:
    name: Lembrete no dia (12:50 BRT)
    if: github.event.schedule == '50 15 * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.tipo == 'dia_da_escala')
    runs-on: ubuntu-latest
    steps:
      - name: Chamar endpoint de lembrete
        run: |
          HTTP_STATUS=$(curl -sL -o /tmp/response.txt -w "%{http_code}" \
            -X GET \
            "${{ secrets.APP_URL }}/api/cron/escalas-lembretes?tipo=dia_da_escala" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}")
          cat /tmp/response.txt
          echo ""
          echo "HTTP Status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "::error::Endpoint retornou status $HTTP_STATUS"
            exit 1
          fi
