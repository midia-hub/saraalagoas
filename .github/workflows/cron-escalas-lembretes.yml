name: Cron – Lembretes de Escala

# Horários em UTC (BRT = UTC-3)
# lembrete_3dias → 08:30 BRT = 11:30 UTC
# lembrete_1dia  → 08:00 BRT = 11:00 UTC
# dia_da_escala  → 09:00 BRT = 12:00 UTC
#
# ⚠ GitHub Actions pode atrasar até ~15 min no plano gratuito.
# Isso é aceitável pois removemos o filtro de janela horária.
#
# Segredos necessários no repositório (Settings → Secrets → Actions):
#   APP_URL     → URL de produção, ex: https://sua-app.vercel.app
#   CRON_SECRET → mesmo valor de CRON_SECRET nas env vars da Vercel

on:
  schedule:
    # lembrete_3dias – 11:30 UTC diariamente
    - cron: '30 11 * * *'
    # lembrete_1dia  – 11:00 UTC diariamente
    - cron: '0 11 * * *'
    # dia_da_escala  – 12:00 UTC diariamente
    - cron: '0 12 * * *'

  # Permite disparar manualmente pela aba Actions no GitHub
  workflow_dispatch:
    inputs:
      tipo:
        description: 'Tipo de lembrete'
        required: true
        default: 'dia_da_escala'
        type: choice
        options:
          - lembrete_3dias
          - lembrete_1dia
          - dia_da_escala

jobs:
  lembrete_3dias:
    name: Lembrete 3 dias antes
    # Roda quando agendado às 11:30 UTC ou quando disparado manualmente com este tipo
    if: github.event.schedule == '30 11 * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.tipo == 'lembrete_3dias')
    runs-on: ubuntu-latest
    steps:
      - name: Chamar endpoint de lembrete
        run: |
          HTTP_STATUS=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
            -X GET \
            "${{ secrets.APP_URL }}/api/cron/escalas-lembretes?tipo=lembrete_3dias" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}")
          cat /tmp/response.txt
          echo ""
          echo "HTTP Status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "::error::Endpoint retornou status $HTTP_STATUS"
            exit 1
          fi

  lembrete_1dia:
    name: Lembrete 1 dia antes
    if: github.event.schedule == '0 11 * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.tipo == 'lembrete_1dia')
    runs-on: ubuntu-latest
    steps:
      - name: Chamar endpoint de lembrete
        run: |
          HTTP_STATUS=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
            -X GET \
            "${{ secrets.APP_URL }}/api/cron/escalas-lembretes?tipo=lembrete_1dia" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}")
          cat /tmp/response.txt
          echo ""
          echo "HTTP Status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "::error::Endpoint retornou status $HTTP_STATUS"
            exit 1
          fi

  dia_da_escala:
    name: Lembrete no dia (9h BRT)
    if: github.event.schedule == '0 12 * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.tipo == 'dia_da_escala')
    runs-on: ubuntu-latest
    steps:
      - name: Chamar endpoint de lembrete
        run: |
          HTTP_STATUS=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
            -X GET \
            "${{ secrets.APP_URL }}/api/cron/escalas-lembretes?tipo=dia_da_escala" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}")
          cat /tmp/response.txt
          echo ""
          echo "HTTP Status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "::error::Endpoint retornou status $HTTP_STATUS"
            exit 1
          fi
